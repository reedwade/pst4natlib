#!/usr/bin/env python

import sys
import mailbox
import email.utils
import glob

from datetime import datetime
import time
from elasticsearch import Elasticsearch

es = Elasticsearch()

print "deleting reedtest index"
es.indices.delete(index="reedtest")

for mbox_file in glob.glob('../../PST/mboxes/*'):
    print
    print "opening mbox file", mbox_file
    print
    count = 0
    messages = mailbox.mbox(mbox_file)
    mailbox_name = mbox_file.split('/')[-1]
    count_within_mbox = 0
    for message in messages:
        count_within_mbox += 1
        count += 1

        for message_part in message.walk():
            if message_part.get_content_type() == 'text/plain':

                if (count % 10) == 0:
                    print " ",count,

                payload = message_part.get_payload()
                if message_part.get_content_charset():
                    try:
                        payload = payload.decode(message_part.get_content_charset()).encode('utf8')
                    except Exception, e:
                        print "skipping message {messageid}: {e}".format(
                            messageid=message['Message-id'],
                            e=e,
                            )
                out = {
                    'index':"reedtest",
                    'doc_type':"email",
                    # id':42,
                    'body':{
                        "subject":  message['subject'],
                        "to":       message['to'],
                        "from":     message['from'],
                        "date":     datetime.fromtimestamp(time.mktime(email.utils.parsedate(message['date']))),
                        "body":     payload,
                        "messageid":    message['Message-id'],
                        "collection_name":   mailbox_name,
                        "collection_message_id":   count_within_mbox,
                    }
                }
                try:
                    es.index(**out)
                except Exception, e:
                    print
                    print "skipping message", message['Message-id']  , ":", str(e)
                    print message_part.get_content_charset()
                    count_within_mbox -= 1
                    # raise



